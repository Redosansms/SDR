<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques Discord en Temps R√©el</title>
    <style>
        /* [Votre CSS existant reste inchang√©] */
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Classement des Membres (Temps R√©el)</h1>
        
        <div class="header">
            <div>#</div>
            <div>Membre</div>
            <div class="user-xp">XP</div>
            <div class="header-messages">Messages</div>
        </div>
        
        <div id="leaderboard">
            <p class="loading">Connexion au flux temps r√©el...</p>
        </div>
        
        <div class="last-update" id="lastUpdate"></div>
    </div>

    <script>
        // Configuration
        const SERVER_URL = 'http://localhost:5001';  // Assurez-vous que c'est la m√™me que server.py
        let usersData = {};
        let eventSource = null;
        
        // √âl√©ments DOM
        const leaderboard = document.getElementById("leaderboard");
        const lastUpdateEl = document.getElementById("lastUpdate");

        // Formatage de la date
        function formatDate(date) {
            return new Date(date).toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Affichage des donn√©es
        function displayData(users) {
            const usersArray = Object.values(users)
                .sort((a, b) => (b.xp || 0) - (a.xp || 0));
            
            leaderboard.innerHTML = usersArray.map((user, index) => `
                <div class="user-card" data-user-id="${user.id}">
                    <div class="user-rank">${index + 1}</div>
                    <div class="user-name" title="${user.username}">${user.username}</div>
                    <div class="user-xp">${user.xp} XP</div>
                    <div class="user-messages">${user.messages} messages</div>
                </div>
            `).join("");
            
            lastUpdateEl.textContent = `Derni√®re mise √† jour : ${formatDate(new Date())}`;
        }

        // Connexion SSE am√©lior√©e
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(`${SERVER_URL}/stream`);

            eventSource.onopen = () => {
                console.log("üîå Connect√© au flux SSE");
                leaderboard.querySelector('.loading').textContent = "Connect√©, en attente de donn√©es...";
            };

            eventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    console.log("üì© Donn√©e SSE re√ßue:", data);

                    if (data.status === 'waiting') return;

                    // Mise √† jour globale ou individuelle
                    if (Array.isArray(data) || data.users) {
                        usersData = data.users || data;
                        displayData(usersData);
                    } else if (data.id) {
                        usersData[data.id] = data;
                        displayData(usersData);
                    }
                } catch (err) {
                    console.error("Erreur traitement SSE:", err);
                }
            };

            eventSource.onerror = (e) => {
                console.error("üö® Erreur SSE:", e);
                leaderboard.innerHTML = `<p class="error">Connexion perdue, reconnexion dans 5s...</p>`;
                setTimeout(connectSSE, 5000);
            };
        }

        // Chargement initial depuis le serveur Flask
        async function loadInitialData() {
            try {
                const response = await fetch(`${SERVER_URL}/update`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.users) {
                        usersData = data.users;
                        displayData(usersData);
                    }
                }
            } catch (err) {
                console.error("Erreur chargement initial:", err);
                leaderboard.innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Serveur inaccessible</h3>
                        <p>V√©rifiez que server.py est bien lanc√©</p>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        // Lancement
        document.addEventListener('DOMContentLoaded', async () => {
            await loadInitialData();
            connectSSE();
            
            // Ping r√©gulier pour √©viter les timeouts
            setInterval(() => {
                if (eventSource) console.log("SSE connection state:", eventSource.readyState);
            }, 30000);
        });
    </script>
</body>
</html>
